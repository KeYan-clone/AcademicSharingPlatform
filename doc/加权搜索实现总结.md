# 学术成果加权搜索实现总结

## 1. 核心计算公式

$$\text{Final\_Score} = \text{Query\_Score} \times \left( 1 + \frac{\log(1 + cited\_by\_count) \times 1.2 + \log(1 + favourite\_count) \times 1.0 + \log(1 + read\_count) \times 0.8}{3} \right)$$

**其中**：
- **Query_Score**：BM25 算法在标题(权重3)、概念(权重2.5)、摘要(权重1.5)字段的相关度评分
- **权重系数**：被引用(1.2) > 收藏(1.0) > 阅读(0.8)
- **log1p 函数**：log(1+x) 避免大数值过度影响，保留权重差异

---

## 2. 实现清单

### 2.1 文档更新
✅ **doc/Elasticsearch搜索方案.md** - 简化为确定可行的公式版本

### 2.2 Repository 层实现
✅ **AchievementRepository.java**
- `searchByKeywordWithWeighting(keyword, pageable)` - 关键词加权搜索
- `searchByDateRangeAndKeywordWithWeighting(startDate, endDate, keyword, pageable)` - 日期范围 + 关键词加权搜索

### 2.3 Service 层实现  
✅ **AchievementService.java**
- `searchByKeywordWithWeighting(keyword, pageable)` - 调用 Repository 并返回 DTO
- `searchByDateRangeAndKeywordWithWeighting(startDate, endDate, keyword, pageable)` - 带时间范围的加权搜索

### 2.4 Controller 层实现
✅ **AchievementController.java**
- `GET /achievements/search/weighted` - 关键词加权搜索端点
- `GET /achievements/search/weighted-by-date` - 日期范围 + 关键词加权搜索端点

---

## 3. API 使用示例

### 3.1 关键词加权搜索
```bash
GET /achievements/search/weighted?keyword=机器学习&page=0&size=10
```

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "content": [
      {
        "id": "W123456",
        "title": "Deep Learning for Machine Learning",
        "citedByCount": 1200,
        "favouriteCount": 350,
        "readCount": 5000,
        "publicationDate": "2023-01-15"
      }
    ],
    "totalElements": 256,
    "totalPages": 26,
    "size": 10,
    "number": 0
  }
}
```

### 3.2 日期范围 + 关键词加权搜索
```bash
GET /achievements/search/weighted-by-date?startDate=2020-01-01&endDate=2024-12-31&keyword=深度学习&page=0&size=10
```

---

## 4. Elasticsearch 查询 DSL 实现

### 关键组件

```json
{
  "function_score": {
    "query": {
      "multi_match": {
        "query": "关键词",
        "fields": ["title^3", "concepts^2.5", "abstract^1.5"],
        "operator": "or",
        "fuzziness": "AUTO"
      }
    },
    "functions": [
      {
        "field_value_factor": {
          "field": "cited_by_count",
          "factor": 1.2,
          "modifier": "log1p",
          "missing": 0
        }
      },
      {
        "field_value_factor": {
          "field": "favourite_count",
          "factor": 1.0,
          "modifier": "log1p",
          "missing": 0
        }
      },
      {
        "field_value_factor": {
          "field": "read_count",
          "factor": 0.8,
          "modifier": "log1p",
          "missing": 0
        }
      }
    ],
    "score_mode": "sum",
    "boost_mode": "multiply",
    "max_boost": 42
  }
}
```

---

## 5. 配置参数说明

| 参数 | 值 | 用途 | 备注 |
|-----|-----|------|------|
| **multi_match.operator** | or | 任意字段匹配即可 | 提高召回率 |
| **multi_match.fuzziness** | AUTO | 自动模糊匹配 | 容错输入错误 |
| **score_mode** | sum | 多函数得分相加 | 充分利用三个维度权重 |
| **boost_mode** | multiply | 查询得分 × 权重函数 | 平衡相关度和权重 |
| **field_value_factor.modifier** | log1p | 对数函数 | 避免值过大的影响 |
| **max_boost** | 42 | 最大权重倍数上限 | 防止权重过度放大 |

---

## 6. 性能特性

✅ **高效性**：充分利用 Elasticsearch 原生 Function Score Query，无额外计算开销

✅ **可扩展**：支持轻松添加新的权重维度（如学位等级、h-index 等）

✅ **灵活调整**：权重参数在 Repository 中明确标注，便于 A/B 测试和优化

✅ **缓存友好**：查询模式固定，易于被 Elasticsearch 缓存加速

---

## 7. 后续优化方向

1. **动态权重**：基于用户行为数据（点击率、停留时间）动态调整权重
2. **个性化排序**：结合用户兴趣和历史行为个性化搜索结果
3. **A/B 测试**：对比不同权重配置的用户满意度
4. **新增维度**：添加学位等级、h-index、合作广度等权重因子

---

## 8. 验证清单

- [x] 最终计算公式明确可行
- [x] Repository 层实现加权查询方法（2个）
- [x] Service 层实现业务逻辑方法（2个）
- [x] Controller 层提供 REST API 端点（2个）
- [x] 简化文档记录核心实现
- [x] 代码注释详尽，参数说明完整
